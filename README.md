# Тестовое задание в MadSoft на позицию Python-разработчик

---

## Задание

Разработайте веб-приложение на Python, используя FastAPI, которое предоставляет API для работы с коллекцией мемов. Приложение должно состоять из двух сервисов: сервис с публичным API с бизнес-логикой и сервис для работы с медиа-файлами, используя S3-совместимое хранилище (н-р, MinIO).     

**Функциональность**:
- GET /memes: Получить список всех мемов (с пагинацией).
- GET /memes/{id}: Получить конкретный мем по его ID.
- POST /memes: Добавить новый мем (с картинкой и текстом).
- PUT /memes/{id}: Обновить существующий мем.
- DELETE /memes/{id}: Удалить мем. 

**Требования**:
- Используйте реляционную СУБД для хранения данных.
- Обеспечьте обработку ошибок и валидацию входных данных.
- Используйте Swagger/OpenAPI для документирования API.
- Напишите хотя бы несколько unit-тестов для проверки основной функциональности.
- Напишите Readme, из которого понятна функциональность проекта и инструкция по локальному запуску для разработки.
- Проект должен состоять минимум из: 1 сервис с публичным API, 1 сервис с приватным API для изображений, 1 сервис СУБД, 1 сервиc S3-storage.
- Напишите docker-compose.yml для запуска проекта.

---

## Описание

Сервисы написаны на `Python 3.12` с использованием `FastAPI` следуя принципам чистой архитектуры. Используется довольно стандартное разделение на слои.\
Для внедрения зависимостей используется di-фреймворк `dishka`, 
он удобнее чем стандартный Depends из `FastAPI`, особенно когда используется ещё что-то вместе с `FastAPI` (например, `FastStream`).

В `docker-compose.prod.yml` сервисы запускаются в `production` режиме, сервис медиа-файлов и `MinIo` доступны там только внутри контейнеров.\
Публично доступно только API сервиса мемов.

Многие моменты упрощены, что-то сделано не идеально (в рамках тестового задания), но всё работает и соответствует требованиям.

### Сервис мемов

Сервис мемов предоставляет публичное API для работы с мемами.

Модель мема:
- `id` - уникальный идентификатор мема
- `title` - заголовок мема
- `description` - описание мема
- `created_at` - дата создания мема
- `image_url` - ссылка на картинку мема

В качестве СУБД используется `PostgreSQL 16`, для работы с ней используется `SQLAlchemy 2.0` (драйвер `asyncpg`) и `Alembic`.\
PostgreSQL разворачивается в Docker-контейнере.

При создании нового мема, картинка отправляется в сервис медиафайлов по `HTTP` с использованием `aiohttp`.\
Для просмотра картинок они скачиваются из сервиса медиафайлов и возвращаются в ответ.
(Можно было просто открывать публичный доступ на чтение файла в MinIO или создавать ссылку, 
но это требует дополнительной настройки и я не уверен, что это подходит под требования задания.)

Заголовок и описание мема изменяются в PUT запросе, картинка изменяется через отдельный PATCH запрос.
Подумал, что будет не очень удобно делать изменение картинки в PUT запросе, так как нужно будет постоянно слать картинку и это накладывает свои ограничения.

Остальную функциональность можно посмотреть в документации API.


### Сервис медиафайлов

Сервис медиафайлов предоставляет приватное API (на проде доступно только внутри контейнера) для работы с файлами.

Для хранения файлов используется S3-совместимое хранилище **MinIO**. 
В докере развернут кластер из 2 minio-сервисов, `nginx` используется как балансировщик.

Для работы с `MinIo` используется стандартная библиотека `minio`. 
(Лучше, наверное, взять какой-то асинхронный вариант, или хотя бы запускать задачи с minio в отдельном потоке, 
но в рамках тестового задания не стал этим заниматься)


---

## Локальный dev запуск

**Требования**:
- Установлен `Docker` (https://docs.docker.com/get-docker/)
- Установлен `Docker Compose` (https://docs.docker.com/compose/install/)
- Свободны порты:
  - `8001` - для сервиса мемов
  - `8002` - для сервиса медиафайлов
  - `5433` - для базы данных
  - `9000` - для minio api
  - `9001` - для minio web
- Make (опционально)

**Запуск**:
1. Создаём `.env` файлы в папках `memes_service` и `media_files_service`, заполняем их на основе `.env.dist`
   1. Для minio пока оставляем заглушки. Можно и сразу отдельно поднять minio и получить всё что нужно, тогда шаги 4-6 можно пропустить.
2. `make up-dev` или `docker compose -f docker-compose.dev.yml up --build` - запуск всех сервисов
3. `make migrate-all` или `docker exec memes_api alembic upgrade heads` - применение миграций базы данных
4. Настраиваем minio:
   1. Переходим по ссылке `http://127.0.0.1:9001` для доступа к minio
   2. Заходим под пользователя `admin` с паролем `password` (прописаны в `docker-compose.dev.yml`)
   3. Создаём bucket, вставляем название в `.env` сервиса медиафайлов
   4. Создаём AccessKey и SecretKey, вставляем их в `.env` сервиса медиафайлов
5. `make down-dev` или `docker compose -f docker-compose.dev.yml down` - остановка всех сервисов для перезагрузки
6. `make up-dev` или `docker compose -f docker-compose.dev.yml up --build` - запуск всех сервисов

Теперь по адресу `http://127.0.0.1:8001` доступен сервис мемов, а по адресу `http://127.0.0.1:8002` - сервис медиафайлов.\
`/api/openapi.json` - openapi.json, `/api/docs` - документация API Swagger, `/api/redoc` - документация API Redoc.

## Тесты
Тесты написаны только для сервиса мемов - покрытие тестами 85%\
Тесты прогоняются с использованием тестовой базы данных.\
База поднимается в контейнере автоматически с помощью плагина `pytest-docker`. 
Для асинхронной работы тестов используется `pytest-asyncio`

**Требования (локальный запуск)**:
- Установлен `Docker` (https://docs.docker.com/get-docker/)
- Установлен `Docker Compose` (https://docs.docker.com/compose/install/)
- Установлен `Python 3.12` (https://www.python.org/downloads/)
- Установлен `Poetry` (https://python-poetry.org/docs/#installation)
- Открыт порт `5434` для тестовой базы данных
- Установлен `Make` (опционально)

Также можно запустить тесты в контейнере, тогда установка Python и Poetry не требуется.

**Запуск (локальный)**:
1. `cd memes_service` - переходим в папку сервиса мемов
2. `make run-tests` или `poetry run pytest -vv tests` - запуск тестов локально


## Контакты
- [Telegram - @printeromg](https://t.me/printeromg)
- [Почта - kitaev.gregory@gmail.com](mailto:kitaev.gregory@gmail.com)